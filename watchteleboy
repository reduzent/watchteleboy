#!/usr/bin/env python3

import argparse
import os
import subprocess
from wt_classes import *
from wt_helpers import *

TELEBOY_LOGIN = 'username'
TELEBOY_PASS = 'password'
VIDEO_OUTPUT_FILE = 'v'
AUDIO_OUTPUT_FILE = 'a'
SESSION_CACHE = 'wt_session'
MPV_COMMAND = '/usr/bin/mpv'
MPV_ARGS = ['--keep-open', '--force-seekable=yes', '--cache=yes', '--audio-file=a', 'v']


parser = argparse.ArgumentParser()
parser.add_argument("-l", "--list", help="list available channels", action="store_true")
parser.add_argument("-c", "--channel", help="play channel")
parser.add_argument("--print-url", help="print url of channel instead of starting playback", action="store_true")
parser.add_argument("-t", "--starttime", help="specify a start time other than 'now'")
args = parser.parse_args()

def main(args):
    wts = WatchTeleboySession(SESSION_CACHE)
    if not wts.logged_in():
        try:
            assert wts.login(user=TELEBOY_LOGIN, password=TELEBOY_PASS)
        except AssertionError:
            sys.exit(1)

    if args.list:
        wts.list_channels()
        sys.exit(0)

    ch = args.channel if args.channel else 'SRF1'
    MPD_URL = wts.get_stream_url(ch)

    if args.print_url:
        print(MPD_URL)
        sys.exit(0)

    os.mkfifo(VIDEO_OUTPUT_FILE)
    os.mkfifo(AUDIO_OUTPUT_FILE)
    MPV_ARGS.insert(0, MPV_COMMAND)
    mpv = subprocess.Popen(MPV_ARGS, stdin=subprocess.PIPE, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
    wt_container = WatchTeleboyStreamContainer(MPD_URL)
    wt_video = wt_container.extract_video_stream()
    wt_audio = wt_container.extract_audio_stream()

    if args.starttime:
        stobj = parse_time_string(args.starttime)
        wt_video.set_start_time(stobj)
        wt_audio.set_start_time(stobj)

    wt_video.nb_download_stream(VIDEO_OUTPUT_FILE)
    wt_audio.nb_download_stream(AUDIO_OUTPUT_FILE)

    mpv.wait()
    wt_video.stop()
    wt_audio.stop()
    os.unlink(VIDEO_OUTPUT_FILE)
    os.unlink(AUDIO_OUTPUT_FILE)
    sys.exit()

if __name__ == '__main__':
    main(args)

